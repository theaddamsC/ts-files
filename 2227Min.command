read -p "是否在下載完後自動關機(y/n)？" AUTOSHOOTDOWN;FILENAME='courseID.txt';while read line;do for((j=1;j<=999;j=j+1));do if [[ -d ${line} ]];then echo "Dir ${line} already exist!";else mkdir ${line};fi;if((j<10));then CHECK="http://wow01.ibrain.com.tw/vod//_definst_/ibrain/${line}///mp4:65v0${line}00${j}.mp4/playlist.m3u8";else CHECK="http://wow01.ibrain.com.tw/vod//_definst_/ibrain/${line}///mp4:65v0${line}0${j}.mp4/playlist.m3u8";fi;if wget -S --spider ${CHECK} 2>&1|grep -q 'Remote file exists';then if [[ -f ./${line}/${line}_第${j}堂.ts ]];then ffmpeg -i ${line}_第${j}堂.ts -bsf:a aac_adtstoasc -acodec copy -vcodec copy ${line}_第${j}堂.mp4;rm ${line}_第${j}堂.ts;elif [[ ! -f ./${line}/${line}_第${j}堂.mp4 ]];then if((j<10));then COURSE="http://wow01.ibrain.com.tw/vod//_definst_/ibrain/${line}///mp4:65v0${line}00${j}.mp4/playlist.m3u8";else COURSE="http://wow01.ibrain.com.tw/vod//_definst_/ibrain/${line}///mp4:65v0${line}0${j}.mp4/playlist.m3u8";fi;mkdir ./${line}/downloading_第${j}堂;DIR="./${line}/downloading_第${j}堂";wget -O ${DIR}/playlist.m3u8 ${COURSE};LIST=`grep 'chunklist' ${DIR}/playlist.m3u8`;echo ${LIST};echo ${COURSE}>${DIR}/url.txt;URL=${COURSE%??????????????};echo ${URL}/{LIST};wget -O ${DIR}/${LIST} ${URL}/${LIST};LAST=`tail -n 2 ${DIR}/${LIST}|head -n 1`;echo ${LAST}>${DIR}/last.txt;NUM=`cat ${DIR}/last.txt|cut -d '_' -f 3|cut -d '.' -f 1`;echo ${NUM};MEDIA=`cat ${DIR}/last.txt|cut -d '_' -f 2`;for((i=0;i<=${NUM};i=i+1));do wget -O ${DIR}/media_${MEDIA}_${i}.ts ${URL}/media_${MEDIA}_${i}.ts;echo ${DIR}/media_${MEDIA}_${i}.ts|tr " " "\n">>${DIR}/tslist.txt;done;while read line;do cat $line>>${line}_第${j}堂.ts;done<${DIR}/tslist.txt;ffmpeg -i ./${line}/${line}_第${j}堂.ts -bsf:a aac_adtstoasc -acodec copy -vcodec copy ./${line}/${line}_第${j}堂.mp4;rm ./${line}${line}_第${j}堂.ts;rm -rf ${DIR};else echo "File ${line}_第${j}堂.mp4 exist!";fi;else echo ${line};j=j-1;echo ${j};break;fi;done;done<${FILENAME};if [ "${AUTOSHOOTDOWN}" == "Y" ]||[ "${AUTOSHOOTDOWN}" == "y" ];then shutdown -h now;elif [ "${AUTOSHOOTDOWN}" == "N" ]||[ "${AUTOSHOOTDOWN}" == "n" ];then echo "Download Done!";else echo "Download Done!";fi
